name: Desktop CI

on:
  push:
    branches: [main]
    tags:
      - 'desktop-v*'
    paths:
      - 'packages/desktop/**'
      - 'packages/shared/**'
      - '.github/workflows/desktop-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/desktop/**'
      - 'packages/shared/**'
      - '.github/workflows/desktop-ci.yml'

permissions:
  contents: write

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_target: aarch64-apple-darwin
            target_triple: aarch64-apple-darwin
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
            rust_target: x86_64-apple-darwin
            target_triple: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ''
            rust_target: ''
            target_triple: ''
          - platform: ubuntu-22.04-arm
            args: ''
            rust_target: ''
            target_triple: ''
          - platform: windows-latest
            args: ''
            rust_target: ''
            target_triple: ''

    runs-on: ${{ matrix.platform }}

    env:
      HAS_MACOS_SIGNING: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 != '' }}
      HAS_MACOS_NOTARIZATION: ${{ secrets.ASC_API_KEY_P8_BASE64 != '' }}
      HAS_WINDOWS_SIGNING: ${{ secrets.AZURE_CLIENT_SECRET != '' }}

    steps:
      - uses: actions/checkout@v4

      # --- Node.js + pnpm ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # --- Rust ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './packages/desktop/src-tauri -> target'

      # --- Linux system dependencies ---
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev xdg-utils

      # --- macOS code signing ---
      - name: Set up macOS code signing keychain
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_SIGNING == 'true'
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          rm -f certificate.p12

      - name: Set up macOS notarization credentials
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_NOTARIZATION == 'true'
        env:
          ASC_API_KEY_P8_BASE64: ${{ secrets.ASC_API_KEY_P8_BASE64 }}
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          KEY_PATH="$HOME/private_keys/AuthKey_${ASC_API_KEY_ID}.p8"
          echo "$ASC_API_KEY_P8_BASE64" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "APPLE_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      # --- Windows signing tool ---
      - name: Install trusted-signing-cli
        if: matrix.platform == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
        run: cargo install trusted-signing-cli

      # --- Install frontend dependencies ---
      # --ignore-scripts avoids building native modules (e.g. better-sqlite3)
      # that belong to other workspace packages and aren't needed for the desktop build
      - name: Install frontend dependencies
        run: pnpm install --ignore-scripts

      # --- Extract changelog ---
      - name: Extract changelog
        id: changelog
        if: startsWith(github.ref, 'refs/tags/desktop-v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#desktop-v}"
          NOTES=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" packages/desktop/CHANGELOG.md)
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # --- Build Tauri app ---
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          APPIMAGE_EXTRACT_AND_RUN: '1'
          # linuxdeploy's bundled strip can't handle .relr.dyn sections on Ubuntu 22.04+
          NO_STRIP: 'true'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_TRIPLE: ${{ matrix.target_triple }}
          # Updater signing
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # macOS code signing
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: "${{ matrix.platform == 'macos-latest' && env.HAS_MACOS_SIGNING == 'true' && 'Developer ID Application: Kyle Graehl (VD7BYQ6ABM)' || '' }}"
          # macOS notarization
          APPLE_API_KEY: ${{ secrets.ASC_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.ASC_API_ISSUER_ID }}
          # Windows signing
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        with:
          projectPath: packages/desktop
          tauriScript: pnpm tauri
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && 'desktop-v__VERSION__' || '' }}
          releaseName: 'Yep Anywhere Desktop v__VERSION__'
          releaseBody: ${{ steps.changelog.outputs.notes || 'See the assets to download and install this version.' }}
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: ${{ startsWith(github.ref, 'refs/tags/') }}
          updaterJsonKeepUniversal: true
          args: >-
            ${{ matrix.args }}
            ${{ matrix.platform == 'windows-latest' && secrets.AZURE_CLIENT_SECRET != '' && '--config ''{"bundle":{"windows":{"signCommand":"trusted-signing-cli -e https://eus.codesigning.azure.net -a kylegraehl -c yep-profile %1"}}}''' || '' }}

      # --- Diagnose flaky DMG bundling ---
      - name: Check for flaky DMG bundling failure
        if: failure() && matrix.platform == 'macos-latest'
        run: |
          echo ""
          echo "::error::macOS DMG bundling failed. This is likely the known flaky hdiutil issue on GitHub Actions runners (not a code problem). Re-run this job: gh run rerun ${{ github.run_id }} --failed"
          echo ""

      # --- Cleanup ---
      - name: Clean up macOS keychain
        if: matrix.platform == 'macos-latest' && always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/private_keys 2>/dev/null || true

  finalize-release:
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Remove .sig files from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release view "$TAG" --json assets --jq '.assets[].name' | grep '\.sig$' | while read -r name; do
            echo "Deleting $name"
            gh release delete-asset "$TAG" "$name" --yes
          done

      - name: Update release body with download table
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#desktop-v}"
          REPO="${GITHUB_REPOSITORY}"
          BASE="https://github.com/${REPO}/releases/download/${TAG}"

          CHANGELOG=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" packages/desktop/CHANGELOG.md)

          # URL-encode the space in "Yep Anywhere" for download links
          NAME="Yep%20Anywhere"

          {
            if [ -n "$CHANGELOG" ]; then
              echo "$CHANGELOG"
              echo ""
            fi
            echo "## Download"
            echo ""
            echo "| Platform | |"
            echo "|----------|-|"
            echo "| macOS (Apple Silicon) | [.dmg](${BASE}/${NAME}_${VERSION}_aarch64.dmg) |"
            echo "| macOS (Intel) | [.dmg](${BASE}/${NAME}_${VERSION}_x64.dmg) |"
            echo "| Windows | [.exe](${BASE}/${NAME}_${VERSION}_x64-setup.exe) · [.msi](${BASE}/${NAME}_${VERSION}_x64_en-US.msi) |"
            echo "| Linux x86_64 | [.deb](${BASE}/yep-anywhere_${VERSION}_amd64.deb) · [.AppImage](${BASE}/yep-anywhere_${VERSION}_amd64.AppImage) |"
            echo "| Linux ARM64 | [.deb](${BASE}/yep-anywhere_${VERSION}_arm64.deb) · [.AppImage](${BASE}/yep-anywhere_${VERSION}_aarch64.AppImage) |"
          } > /tmp/release-body.md

          gh release edit "$TAG" --notes-file /tmp/release-body.md
