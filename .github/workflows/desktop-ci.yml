name: Desktop CI

on:
  push:
    branches: [main]
    tags:
      - 'desktop-v*'
    paths:
      - 'packages/desktop/**'
      - 'packages/shared/**'
      - '.github/workflows/desktop-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/desktop/**'
      - 'packages/shared/**'
      - '.github/workflows/desktop-ci.yml'

permissions:
  contents: write

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_target: aarch64-apple-darwin
            target_triple: aarch64-apple-darwin
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
            rust_target: x86_64-apple-darwin
            target_triple: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ''
            rust_target: ''
            target_triple: ''
          - platform: ubuntu-22.04-arm
            args: ''
            rust_target: ''
            target_triple: ''
          - platform: windows-latest
            args: ''
            rust_target: ''
            target_triple: ''

    runs-on: ${{ matrix.platform }}

    env:
      HAS_MACOS_SIGNING: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 != '' }}
      HAS_MACOS_NOTARIZATION: ${{ secrets.ASC_API_KEY_P8_BASE64 != '' }}
      HAS_WINDOWS_SIGNING: ${{ secrets.AZURE_CLIENT_SECRET != '' }}
      HAS_UPDATER_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY != '' }}
      # linuxdeploy AppImage compat: strip can't handle .relr.dyn on Ubuntu 22.04+,
      # and CI runners may lack FUSE for running the linuxdeploy AppImage
      NO_STRIP: 'true'
      APPIMAGE_EXTRACT_AND_RUN: '1'

    steps:
      - uses: actions/checkout@v4

      # --- Node.js + pnpm ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # --- Rust ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './packages/desktop/src-tauri -> target'

      # --- Linux system dependencies ---
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev xdg-utils

      # --- macOS code signing ---
      - name: Set up macOS code signing keychain
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_SIGNING == 'true'
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          rm -f certificate.p12

      - name: Set up macOS notarization credentials
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_NOTARIZATION == 'true'
        env:
          ASC_API_KEY_P8_BASE64: ${{ secrets.ASC_API_KEY_P8_BASE64 }}
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          KEY_PATH="$HOME/private_keys/AuthKey_${ASC_API_KEY_ID}.p8"
          echo "$ASC_API_KEY_P8_BASE64" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "APPLE_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      # --- Signing env vars ---
      # These MUST be set conditionally via GITHUB_ENV, not in the static env block.
      # Tauri's bundler treats empty-string env vars as "present" and crashes
      # trying to decode empty keys or import empty certificates.
      - name: Set signing env vars
        shell: bash
        run: |
          if [ "${{ env.HAS_UPDATER_KEY }}" = "true" ]; then
            echo "TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" >> "$GITHUB_ENV"
            echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" >> "$GITHUB_ENV"
          fi
          if [ "${{ env.HAS_MACOS_SIGNING }}" = "true" ] && [ "${{ matrix.platform }}" = "macos-latest" ]; then
            echo "APPLE_CERTIFICATE<<CERT_EOF" >> "$GITHUB_ENV"
            echo "${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}" >> "$GITHUB_ENV"
            echo "CERT_EOF" >> "$GITHUB_ENV"
            echo "APPLE_CERTIFICATE_PASSWORD=${{ secrets.MACOS_CERTIFICATE_PASSWORD }}" >> "$GITHUB_ENV"
            echo "APPLE_SIGNING_IDENTITY=Developer ID Application: Kyle Graehl (VD7BYQ6ABM)" >> "$GITHUB_ENV"
          fi
          if [ "${{ env.HAS_MACOS_NOTARIZATION }}" = "true" ] && [ "${{ matrix.platform }}" = "macos-latest" ]; then
            echo "APPLE_API_KEY=${{ secrets.ASC_API_KEY_ID }}" >> "$GITHUB_ENV"
            echo "APPLE_API_ISSUER=${{ secrets.ASC_API_ISSUER_ID }}" >> "$GITHUB_ENV"
          fi

      # --- Windows signing tool ---
      - name: Install trusted-signing-cli
        if: matrix.platform == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
        run: cargo install trusted-signing-cli

      # --- Install frontend dependencies ---
      # --ignore-scripts avoids building native modules (e.g. better-sqlite3)
      # that belong to other workspace packages and aren't needed for the desktop build
      - name: Install frontend dependencies
        run: pnpm install --ignore-scripts

      # --- Extract changelog ---
      - name: Extract changelog
        id: changelog
        if: startsWith(github.ref, 'refs/tags/desktop-v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#desktop-v}"
          NOTES=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" packages/desktop/CHANGELOG.md)
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # --- Build Tauri app ---
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_TRIPLE: ${{ matrix.target_triple }}
          # Windows signing
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        with:
          projectPath: packages/desktop
          tauriScript: pnpm tauri
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && 'desktop-v__VERSION__' || '' }}
          releaseName: 'Yep Anywhere Desktop v__VERSION__'
          releaseBody: ${{ steps.changelog.outputs.notes || 'See the assets to download and install this version.' }}
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: ${{ startsWith(github.ref, 'refs/tags/') }}
          updaterJsonKeepUniversal: true
          # On Linux, bundle bun as a resource instead of externalBin to avoid Tauri's
          # built-in patchelf corrupting bun's ELF layout (github.com/tauri-apps/tauri/issues/11898).
          # Resources land in the same resource_dir() but aren't patchelf'd.
          args: >-
            ${{ matrix.args }}
            ${{ runner.os == 'Linux' && '--config ''{"bundle":{"externalBin":[],"resources":["binaries/bun-*"]}}''' || '' }}
            ${{ env.HAS_UPDATER_KEY == 'true' && '--config ''{"bundle":{"createUpdaterArtifacts":"v2"}}''' || '' }}
            ${{ matrix.platform == 'windows-latest' && secrets.AZURE_CLIENT_SECRET != '' && '--config ''{"bundle":{"windows":{"signCommand":"trusted-signing-cli -e https://eus.codesigning.azure.net -a kylegraehl -c yep-profile %1"}}}''' || '' }}

      # --- Diagnose flaky DMG bundling ---
      - name: Check for flaky DMG bundling failure
        if: failure() && matrix.platform == 'macos-latest'
        run: |
          echo ""
          echo "::error::macOS DMG bundling failed. This is likely the known flaky hdiutil issue on GitHub Actions runners (not a code problem). Re-run this job: gh run rerun ${{ github.run_id }} --failed"
          echo ""

      # --- Cleanup ---
      - name: Clean up macOS keychain
        if: matrix.platform == 'macos-latest' && always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/private_keys 2>/dev/null || true

  finalize-release:
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Remove .sig files from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release view "$TAG" --json assets --jq '.assets[].name' | grep '\.sig$' | while read -r name; do
            echo "Deleting $name"
            gh release delete-asset "$TAG" "$name" --yes
          done

      - name: Update release body with download table
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#desktop-v}"
          REPO="${GITHUB_REPOSITORY}"
          BASE="https://github.com/${REPO}/releases/download/${TAG}"

          CHANGELOG=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" packages/desktop/CHANGELOG.md)

          {
            if [ -n "$CHANGELOG" ]; then
              echo "$CHANGELOG"
              echo ""
            fi
            echo "## Download"
            echo ""
            echo "| Platform | |"
            echo "|----------|-|"
            echo "| macOS (Apple Silicon) | [.dmg](${BASE}/YepAnywhere_${VERSION}_aarch64.dmg) |"
            echo "| macOS (Intel) | [.dmg](${BASE}/YepAnywhere_${VERSION}_x64.dmg) |"
            echo "| Windows | [.exe](${BASE}/YepAnywhere_${VERSION}_x64-setup.exe) · [.msi](${BASE}/YepAnywhere_${VERSION}_x64_en-US.msi) |"
            echo "| Linux x86_64 | [.AppImage](${BASE}/YepAnywhere_${VERSION}_amd64.AppImage) · [.deb](${BASE}/YepAnywhere_${VERSION}_amd64.deb) · [.rpm](${BASE}/YepAnywhere-${VERSION}-1.x86_64.rpm) |"
            echo "| Linux ARM64 | [.AppImage](${BASE}/YepAnywhere_${VERSION}_aarch64.AppImage) · [.deb](${BASE}/YepAnywhere_${VERSION}_arm64.deb) · [.rpm](${BASE}/YepAnywhere-${VERSION}-1.aarch64.rpm) |"
          } > /tmp/release-body.md

          gh release edit "$TAG" --notes-file /tmp/release-body.md
